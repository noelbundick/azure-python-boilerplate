parameters:
  os: linux
  toxenvs: []

jobs:
- job: ${{ format('Build_{0}', parameters.os) }}

  pool:
    ${{ if eq(parameters.os, 'linux') }}:
      vmImage: ubuntu-16.04
    ${{ if eq(parameters.os, 'windows') }}:
      vmImage: windows-2019

  strategy:
    matrix:
      ${{ each env in parameters.toxenvs }}:
        ${{ env }}:
          TOXENV: ${{ env }}
          ${{ if or(eq(env, 'py27'), startsWith(env, 'py27-')) }}:
            python.version: 2.7
          ${{ if or(eq(env, 'py34'), startsWith(env, 'py34-')) }}:
            python.version: 3.4
          ${{ if or(eq(env, 'py35'), startsWith(env, 'py35-')) }}:
            python.version: 3.5
          ${{ if or(eq(env, 'py36'), startsWith(env, 'py36-')) }}:
            python.version: 3.6
          ${{ if or(eq(env, 'py37'), startsWith(env, 'py37-')) }}:
            python.version: 3.7

  steps:
  - task: UsePythonVersion@0
    displayName: Use Python $(python.version)
    inputs:
      versionSpec: '$(python.version)'

  - script: python -m pip install tox -U
    displayName: Install tox

  - script: tox --notest
    displayName: Provision tox environments

  - script: tox
    displayName: Run tox tests

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
      reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'
